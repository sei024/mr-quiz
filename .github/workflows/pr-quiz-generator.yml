# PR Quiz Generator
# PR‰ΩúÊàêÊôÇ„Å´„Éà„É™„Ç¨„Éº„Åó„ÄÅWorkload Identity Federation„ÅßË™çË®º„Åó„Å¶Cloud Run„ÇíÂëº„Å≥Âá∫„Åó„ÄÅ
# GitHub AppË™çË®º„Åß„ÇØ„Ç§„Ç∫„ÇíPR„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ÊäïÁ®ø

name: PR Quiz Generator

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Workload Identity Federation„Å´ÂøÖË¶Å

jobs:
  generate-quiz:
    name: Generate Quiz via Cloud Run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'id_token'
          id_token_audience: ${{ secrets.CLOUD_RUN_URL }}
          id_token_include_email: true

      - name: Get PR diff
        id: diff
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          # PR„ÅÆ„Éô„Éº„Çπ„Éñ„É©„É≥„ÉÅ„Å®„ÅÆÂ∑ÆÂàÜ„ÇíÂèñÂæó
          git fetch origin "$BASE_REF"
          DIFF=$(git diff "origin/$BASE_REF...HEAD")

          # Â∑ÆÂàÜ„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠òÔºàJSON„Ç®„Çπ„Ç±„Éº„Éó„ÅÆ„Åü„ÇÅÔºâ
          echo "$DIFF" > /tmp/diff.txt

          # Â∑ÆÂàÜ„ÅÆË°åÊï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          DIFF_LINES=$(echo "$DIFF" | wc -l)
          echo "diff_lines=$DIFF_LINES" >> $GITHUB_OUTPUT

          if [ "$DIFF_LINES" -lt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files
        id: files
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          FILES=$(git diff --name-only "origin/$BASE_REF...HEAD" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Generate GitHub App Token
        if: steps.diff.outputs.skip == 'false'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Skip if diff is too small
        if: steps.diff.outputs.skip == 'true'
        run: echo "Diff is too small, skipping quiz generation"

      - name: Generate quiz with IAM authentication
        if: steps.diff.outputs.skip == 'false'
        id: quiz
        env:
          CLOUD_RUN_URL: ${{ secrets.CLOUD_RUN_URL }}
          ID_TOKEN: ${{ steps.auth.outputs.id_token }}
          FILES_CHANGED: ${{ steps.files.outputs.files }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ACCOUNT_ID: ${{ github.event.pull_request.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # diff„ÇíJSON„Ç®„Çπ„Ç±„Éº„Éó„Åó„Å¶„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
          jq -Rs . /tmp/diff.txt > /tmp/diff.json

          # jq„ÅßJSONÂÆâÂÖ®„Å´„Éö„Ç§„É≠„Éº„Éâ„ÇíÊßãÁØâÔºàdiff„ÅØ„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø„ÄÅÂºïÊï∞Èï∑Âà∂Èôê„ÇíÂõûÈÅøÔºâ
          jq -n \
            --arg platform "github" \
            --arg owner "$REPO_OWNER" \
            --arg repo "$REPO_NAME" \
            --argjson number "$PR_NUMBER" \
            --arg accountId "$ACCOUNT_ID" \
            --arg title "$PR_TITLE" \
            --slurpfile diff /tmp/diff.json \
            --argjson filesChanged "$FILES_CHANGED" \
            '{platform: $platform, owner: $owner, repo: $repo, number: $number, accountId: $accountId, title: $title, diff: $diff[0], filesChanged: $filesChanged}' \
            > /tmp/payload.json

          # IAMË™çË®º‰ªò„Åç„ÅßAPI„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°Ôºà„Éö„Ç§„É≠„Éº„Éâ„ÅØ„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø„ÄÅÂºïÊï∞Èï∑Âà∂Èôê„ÇíÂõûÈÅøÔºâ
          RESPONSE=$(curl -s -X POST "$CLOUD_RUN_URL/api/quiz/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ID_TOKEN" \
            -d @/tmp/payload.json)

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          # „É¨„Çπ„Éù„É≥„Çπ„Åã„Çâ„ÇØ„Ç§„Ç∫ÊÉÖÂ†±„ÇíÊäΩÂá∫
          QUIZ_ID=$(echo "$RESPONSE" | jq -r '.quizId')
          QUESTION=$(echo "$RESPONSE" | jq -r '.questionText')
          CATEGORY=$(echo "$RESPONSE" | jq -r '.category')
          DIFFICULTY=$(echo "$RESPONSE" | jq -r '.difficulty')
          OPTIONS=$(echo "$RESPONSE" | jq -r '.options | to_entries | map("- **\(.key + 1).** \(.value)") | join("\n")')

          echo "quiz_id=$QUIZ_ID" >> $GITHUB_OUTPUT
          echo "question<<EOF" >> $GITHUB_OUTPUT
          echo "$QUESTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "difficulty=$DIFFICULTY" >> $GITHUB_OUTPUT
          echo "options<<EOF" >> $GITHUB_OUTPUT
          echo "$OPTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post quiz as comment
        if: steps.diff.outputs.skip == 'false' && steps.quiz.outputs.quiz_id != '' && steps.quiz.outputs.quiz_id != 'null'
        uses: actions/github-script@v7
        env:
          QUIZ_ID: ${{ steps.quiz.outputs.quiz_id }}
          QUESTION: ${{ steps.quiz.outputs.question }}
          CATEGORY: ${{ steps.quiz.outputs.category }}
          DIFFICULTY: ${{ steps.quiz.outputs.difficulty }}
          OPTIONS: ${{ steps.quiz.outputs.options }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const quizId = process.env.QUIZ_ID;
            const question = process.env.QUESTION;
            const category = process.env.CATEGORY;
            const difficulty = process.env.DIFFICULTY;
            const options = process.env.OPTIONS;

            const difficultyEmoji = {
              'easy': 'üü¢',
              'medium': 'üü°',
              'hard': 'üî¥'
            };

            const categoryLabel = {
              'bug_fix': 'üêõ Bug Fix',
              'performance': '‚ö° Performance',
              'refactoring': 'üîß Refactoring',
              'security': 'üîí Security',
              'logic': 'üí° Logic'
            };

            const body = `## üéØ PR Quiz Time!

            **Category:** ${categoryLabel[category] || category}
            **Difficulty:** ${difficultyEmoji[difficulty] || ''} ${difficulty}

            ### Question
            ${question}

            ### Options
            ${options}

            ---

            <details>
            <summary>üìù How to answer</summary>

            Reply to this comment with your answer number (1-4).

            Example: \`1\`

            Quiz ID: \`${quizId}\`
            </details>

            ---
            *ü§ñ Generated by MR/PR Quiz Bot (IAM Auth)*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
